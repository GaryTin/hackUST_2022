


<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Test Manu Page</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.7.1/dist/web3.min.js"></script>
</head>

<body>

    <br >
    <button onclick="manu_get_all_data();">Get all record</button>

    <form onsubmit="add_product();return false;" action="#">
        <label for="prod_type" class="input_label">prod_type</label>
        <input type="text" name="prod_type" id="prod_type" class="input_field" required><br>
        <label for="prod_wholesale_price" class="input_label">prod_wholesale_price</label>
        <input type="text" name="prod_wholesale_price" id="prod_wholesale_price" class="input_field" required><br>
        <label for="quantity" class="input_label">quantity</label>
        <input type="number" name="quantity"  id="quantity" min="1" class="input_field" required><br>
        <input type="submit" value="Submit" class="submit_btn">
    </form>
    <br><br>

    <form action="{% url 'testm' %}" method="POST" enctype='multipart/form-data' id="add_image_form">
        {% csrf_token %}
        <ul>
           {{ add_img_form.as_ul }}
        </ul>
        <div id="registration-action">
            <button>Submit</button>
        </div>
    </form>
    <br><br>

    <form onsubmit="retailer_purchase_from_manu();return false" action="#">
        <label for="retailer_address" class="input_label">Retailer Address</label>
        <input type="text" name="retailer_address" id="retailer_address" class="input_field" required><br>
        <label for="prod_type_r" class="input_label">prod_type</label>
        <input type="text" name="prod_type_r" id="prod_type_r" class="input_field" required><br>
        <label for="quantity_r" class="input_label">quantity</label>
        <input type="number" name="quantity_r"  id="quantity_r" min="1" class="input_field" required><br>
        <input type="submit" value="Submit" class="submit_btn">
    </form>

    <br /><br />
    Status: <span id="status">Loading...</span>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript">
    var index_list=[];
    function add_id()
    {
        var id = document.getElementById('prod_index').value;
        index_list.push(id);
        document.getElementById('prod_index_list').innerHTML=index_list;
        document.getElementById('prod_index').value="";
    }

    async function loadWeb3() {
        if (window.ethereum) {
            window.web3 = new Web3(window.ethereum);
            window.ethereum.enable();
        }
    }

    async function load() {
        await loadWeb3();
        window.contract = await loadContract();
        const account = await getCurrentAccount();
        document.getElementById("add_image_form").style.display="none";
        updateStatus('Ready!');
    }

    function updateStatus(status) {
        const statusEl = document.getElementById('status');
        statusEl.innerHTML = status;
        console.log(status);
    }
    async function loadContract()
    {
        return await new window.web3.eth.Contract([
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "prod_index",
				"type": "string"
			}
		],
		"name": "retailer_receipt",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "new_manufacturer",
				"type": "address"
			}
		],
		"name": "add_manufacturer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "prod_type",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "m_address",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "prod_production_date",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "prod_wholesale_price",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "prod_retail_price",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			}
		],
		"name": "add_product",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "new_retailers",
				"type": "address"
			}
		],
		"name": "add_retailer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256[]",
				"name": "prod_id_list",
				"type": "uint256[]"
			},
			{
				"internalType": "address",
				"name": "b_address",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "purchase_date",
				"type": "uint256"
			}
		],
		"name": "buyer_purchase_from_retailer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "pid",
				"type": "uint256"
			}
		],
		"name": "buyer_view_comment",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "a",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "b",
				"type": "string"
			}
		],
		"name": "compareStrings",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "b_address",
				"type": "address"
			}
		],
		"name": "get_all_uncomment_prod",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "r_address",
				"type": "address"
			}
		],
		"name": "get_lastest_retailer_record",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "m_address",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "prod_type",
				"type": "string"
			}
		],
		"name": "get_remaining",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "input_address",
				"type": "address"
			}
		],
		"name": "get_role",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "b_address",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "prod_id",
				"type": "uint256"
			}
		],
		"name": "get_uncomment_prod_by_id",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "b_address",
				"type": "address"
			}
		],
		"name": "get_user_history",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "m_address",
				"type": "address"
			}
		],
		"name": "manu_get_all_data",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "m_address",
				"type": "address"
			}
		],
		"name": "remove_manufacturer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "r_address",
				"type": "address"
			}
		],
		"name": "remove_retailer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "r_address",
				"type": "address"
			}
		],
		"name": "retailer_get_all_prod_type",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "pid",
				"type": "uint256"
			}
		],
		"name": "retailer_get_prod_info_by_pid",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "m_address",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "r_address",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "prod_type",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "purchase_date",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			}
		],
		"name": "retailer_purchase_from_manu",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "r_address",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_prod_type",
				"type": "string"
			}
		],
		"name": "retailer_view_comment",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "pid",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			},
			{
				"internalType": "uint8",
				"name": "rate",
				"type": "uint8"
			}
		],
		"name": "set_comment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
], '0x1f8269977E52c009D41B51d282fD15984B7c450f');
    }

    async function add_product() {

        updateStatus(`Try to add product`);
        const account = await getCurrentAccount();
        var ac = account.substring(2,account.length-1);
        var prod_type = document.getElementById("prod_type").value + "_"+ ac;
        var prod_wholesale_price = document.getElementById("prod_wholesale_price").value.toString();
        var prod_retail_price = (parseFloat(prod_wholesale_price) *1.4).toString();
        var quantity = document.getElementById("quantity").value;
        console.log("Form data: ");
        console.log(account);
        console.log(prod_type);
        console.log(prod_wholesale_price);
        console.log(prod_retail_price);
        console.log(quantity);



        //console.log("Start!");
        //const tx = await window.contract.methods.add_product(prod_type,account,Date.now(),prod_wholesale_price,prod_retail_price,quantity).send({ from: account });
        //updateStatus('Updated.');



        document.getElementById("add_image_form").style.display="block";
        document.getElementById("id_prod_type").value=prod_type;
    }

     async function manu_get_all_data() {
        updateStatus(`Try to read product`);
        const account = await getCurrentAccount();
        const data = await window.contract.methods.manu_get_all_data(account).call({ from: account });
        console.log(data);
        //download("test.txt",data);
        build_array(data);
        generate_table(build_array(data),"dataTable");
        updateStatus('Get data!');
    }

    async function retailer_purchase_from_manu()
    {
        updateStatus(`Try to buy product from manu`);
        const account = await getCurrentAccount();
        var retailer_address = document.getElementById("retailer_address").value;
        var ac = account.substring(2,account.length-1);
        var prod_type = document.getElementById("prod_type_r").value + "_"+ ac;
        var quantity = document.getElementById("quantity_r").value;
        console.log("Form data: ");
        console.log(account);
        console.log(retailer_address);
        console.log(prod_type);
        console.log(quantity);

        //console.log("Start!");
        //const tx = await window.contract.methods.retailer_purchase_from_manu(account,retailer_address,prod_type,Date.now(),quantity).send({ from: account });

        //const data = await window.contract.methods.get_lastest_retailer_record(web3.utils.toChecksumAddress(retailer_address)).call();
        //var filename = "retailer_"+retailer_address.toString()+"_receipt.txt";
        //download(filename,data);

        //updateStatus('Updated.');

    }
    function download(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }



    function build_array(data)
    {
        var result = [];
        var split_data = data.split(",");
        split_data.pop();

        for (var i =0;i<split_data.length;i++)
        {
            var temp = split_data[i].substring(1,split_data[i].length-1);
            temp = temp.split("/");
            result.push(temp);
        };
        //console.log("Done");
        //console.log(result);
        return result;

    }

    function generate_table(data,id) {

        //delete old table
        var removeTab = document.getElementById(id);
        if (removeTab != null)
        {
            var parentEl = removeTab.parentElement;
            parentEl.removeChild(removeTab);
        }

        // get the reference for the body
        var body = document.getElementsByTagName("body")[0];

        // creates a <table> element and a <tbody> element
        var tbl = document.createElement("table");
        var tblBody = document.createElement("tbody");

        // creating all cells
        for (var i = 0; i < data.length; i++)
        {
            // creates a table row
            var row = document.createElement("tr");

            for (var j = 0; j < data[0].length; j++)
            {
                // Create a <td> element and a text node, make the text
                // node the contents of the <td>, and put the <td> at
                // the end of the table row
                var cell = document.createElement("td");
                var cellText = document.createTextNode(data[i][j]);
                cell.appendChild(cellText);
                row.appendChild(cell);
            }

            // add the row to the end of the table body
            tblBody.appendChild(row);
        }

        // put the <tbody> in the <table>
        tbl.appendChild(tblBody);
        // appends <table> into <body>
        body.appendChild(tbl);
        // sets the border attribute of tbl to 2;
        tbl.setAttribute("border", "2");
        tbl.setAttribute("id", id);
    }


    async function getCurrentAccount() {
        const accounts = await window.web3.eth.getAccounts();
        return accounts[0];
    }



    load();
    </script>
</body>

</html>